<!--Version V2!!!!! -->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>V2Current Noiselevels at the FH Salzburg</title>

    <meta charset="utf-8" />
	<link rel="shortcut icon" href="/favicon.ico"/>   <!--Favicon from:  https://www.flaticon.com/de/kostenloses-icon/larm_2375560?related_id=2375580&origin=search -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This maps shows the current noiselevels at diffenernt locations at the FH Salzburg. The noiselevel is measured with Commend Intercom devices." />
    <meta name="keywords" content="Noiselevel, FH Salzburg, Commend" />
    <meta name="author" content="dgahleitner" /><meta name="version" content="1.0" />
    <meta name="screenshot" content="screenshot.jpg" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3.0.0-preview.6/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3.0.0-preview.6/atlas.min.js"></script>

    <script>
        // whole website is based on: https://github.com/Azure-Samples/AzureMapsCodeSamples/blob/main/Samples/Demos/Create%20a%20Choropleth%20Map/Create%20a%20Choropleth%20Map.html
        //Polygons were created with: https://vector.rocks/
        var map, datasource, popup, maxValue = 500;

        //Gradient was generated by https://colordesigner.io/gradient-generator
        var defaultColor = '#49fa51';
        var colorScale = [
            30, '#a0dc00',
            50, '#cdba00',
            70, '#eb9500',
            90, '#fa6c11',
            100, '#f94141'
        ];

        function GetMap() {
            //Initialize a map instance.
            map = new atlas.Map('myMap', {  
                center: [13.087251, 47.722960], //Position of FH Salzburg
                zoom: 17,
                view: 'Auto',

                //Add authentication details for connecting to Azure Maps.
                authOptions: {
                    //Use Azure Active Directory authentication.
                    //authType: 'anonymous',
                    //clientId: 'e6b6ab59-eb5d-4d25-aa57-581135b927f0', //Your Azure Maps client id for accessing your Azure Maps account.
                    //getToken: function (resolve, reject, map) {
                        //URL to your authentication service that retrieves an Azure Active Directory Token.
                    //    var tokenServiceUrl = "https://samples.azuremaps.com/api/GetAzureMapsToken";

                    //    fetch(tokenServiceUrl).then(r => r.text()).then(token => resolve(token));
                    //}

                    //Alternatively, use an Azure Maps key. Get an Azure Maps key at https://azure.com/maps. NOTE: The primary key should be used as the key.
                    authType: 'subscriptionKey',
                    subscriptionKey: 'k1bs-UljWG2PGIuaoqoG8Xkl_Vf30wvm0gJQdaL5h2c'  //David Gahleitners personal Key (FHS Account)
                }
            });

            //Create a legend.
            createLegend();

            //Wait until the map resources are ready.
            map.events.add('ready', function () {
                //Create a popup but leave it closed so we can update it and display it later.
                popup = new atlas.Popup({
                    position: [0, 0]
                });

                //Create a data source and add it to the map.
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                //Create a stepped expression based on the color scale. 
                var steppedExp = [
                    'step',
                    ['get', 'density'],
                    defaultColor
                ];

                steppedExp = steppedExp.concat(colorScale);
                
                //Create a layer to render the polygon data.
                var polygonLayer = new atlas.layer.PolygonLayer(datasource, null, {
                    fillColor: steppedExp
                });
                map.layers.add(polygonLayer, 'labels');

                //Add a mouse move event to the polygon layer to show a popup with information.
                map.events.add('mousemove', polygonLayer, function (e) {
                    if (e.shapes && e.shapes.length > 0) {
                        var properties = e.shapes[0].getProperties();

                        //Update the content of the popup.
                        popup.setOptions({
                            content: '<div style="padding:10px"><b>' + properties.name + '</b><br/>Noiselevel: ' + properties.density + ' dB</div>',
                            position: e.position
                        });

                        //Open the popup.
                        popup.open(map);
                    }
                });

                //Add a mouse leave event to the polygon layer to hide the popup.
                map.events.add('mouseleave', polygonLayer, function (e) {
                    popup.close();
                });

                //Download a GeoJSON feed and add the data to the data source.
                datasource.importDataFromUrl('data.json');
            });
        }

        function createLegend() {
            var html = [];

            html.push('<i style="background:', defaultColor, '"></i> 0-', colorScale[0], '<br/>');

            for (var i = 0; i < colorScale.length; i += 2) {
                html.push(
                    '<i style="background:', (colorScale[i + 1]), '"></i> ',
                    colorScale[i], (colorScale[i + 2] ? '&ndash;' + colorScale[i + 2] + '<br/>' : '+')
                );
            }

            document.getElementById('legend').innerHTML += html.join('');
        }
    </script>
    <style>
        #legend {
            position: absolute;
            top: 5px;
            left: 5px;
            font-family: Arial;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 5px;
            line-height:18px;
        }

        #legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>
<body onload="GetMap()">
    <div id="myMap" style="position:relative;width:100%;min-width:290px;height:90vh;"></div>

    <div id="legend">Noiselevel<br/>(dB)<br/></div>

    <fieldset style="width:calc(100% - 30px);min-width:290px;margin-top:10px;">
        <legend>Noiselevel Map</legend>
        This maps shows the current noiselevels at diffenernt locations at the FH Salzburg. The noiselevel is measured with Commend Intercom devices. 
    </fieldset>
</body>
</html>